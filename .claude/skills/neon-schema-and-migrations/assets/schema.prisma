// Prisma Schema for Neon Postgres RAG Chatbot
// Generated by neon-schema-and-migrations skill

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication & User Management
// ============================================

model User {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique @db.VarChar(255)
  name      String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  profile  UserProfile?
  sessions ChatSession[]

  @@index([email])
  @@map("users")
}

model UserProfile {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String   @unique @map("user_id") @db.Uuid
  softwareBackground  String?  @map("software_background") @db.Text
  hardwareBackground  String?  @map("hardware_background") @db.Text
  learningGoals       String?  @map("learning_goals") @db.Text
  experienceLevel     String?  @map("experience_level") @db.VarChar(50)
  preferredLanguage   String   @default("en") @map("preferred_language") @db.VarChar(10)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profiles")
}

// ============================================
// Chat & Messaging
// ============================================

model ChatSession {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  title     String?  @db.VarChar(500)
  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("chat_sessions")
}

model Message {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId    String   @map("session_id") @db.Uuid
  role         String   @db.VarChar(50)
  content      String   @db.Text
  selectedText String?  @map("selected_text") @db.Text
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  session   ChatSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  citations MessageCitation[]

  @@index([sessionId])
  @@index([createdAt])
  @@map("messages")
}

model MessageCitation {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  messageId      String   @map("message_id") @db.Uuid
  documentId     String?  @map("document_id") @db.VarChar(255)
  chunkId        String?  @map("chunk_id") @db.VarChar(255)
  score          Float?
  citationIndex  Int?     @map("citation_index")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([documentId])
  @@map("message_citations")
}

// ============================================
// Schema Migrations Tracking
// ============================================

model SchemaMigration {
  id          Int      @id @default(autoincrement())
  version     String   @unique @db.VarChar(255)
  appliedAt   DateTime @default(now()) @map("applied_at")
  description String?  @db.Text

  @@map("schema_migrations")
}