name: Module 3 Content Validation

on:
  push:
    branches: [ 007-author-module-3, main ]
    paths:
      - 'website/docs/module-3/**'
      - 'specs/007-author-module-3/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'website/docs/module-3/**'
      - 'specs/007-author-module-3/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-module-3-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Module 3 directory structure
        run: |
          MODULE_3_PATH="website/docs/module-3"

          if [ ! -d "$MODULE_3_PATH" ]; then
            echo "ERROR: Module 3 directory not found"
            exit 1
          fi

          echo "Validating Module 3 structure..."

          # Check for required files
          if [ ! -f "$MODULE_3_PATH/index.md" ]; then
            echo "ERROR: Module 3 index.md not found"
            exit 1
          else
            echo "✓ Module 3 index.md exists"
          fi

          # Check for week directories
          for week in {1..5}; do
            WEEK_DIR="$MODULE_3_PATH/week-$week"
            if [ ! -d "$WEEK_DIR" ]; then
              echo "ERROR: Week directory $WEEK_DIR not found"
              exit 1
            else
              echo "✓ Week directory $WEEK_DIR exists"

              # Count lesson and lab files in each week
              LESSON_COUNT=$(find "$WEEK_DIR" -name "*.md" -not -name "*lab*" -type f | wc -l)
              LAB_COUNT=$(find "$WEEK_DIR" -name "*lab*.md" -type f | wc -l)

              echo "  Found $LESSON_COUNT lessons and $LAB_COUNT labs"

              if [ "$LAB_COUNT" -eq 0 ]; then
                echo "WARNING: No lab files found in $WEEK_DIR"
              fi
            fi
          done

          # Check for assessment file
          ASSESSMENT_FILE="$MODULE_3_PATH/week-5/module-3-assessment.md"
          if [ ! -f "$ASSESSMENT_FILE" ]; then
            echo "INFO: Assessment file not found (might be acceptable)"
          else
            echo "✓ Module 3 assessment file exists"
          fi

          # Check for troubleshooting guide
          TROUBLESHOOTING_FILE="$MODULE_3_PATH/week-5/troubleshooting-guide.md"
          if [ ! -f "$TROUBLESHOOTING_FILE" ]; then
            echo "INFO: Troubleshooting guide not found (might be acceptable)"
          else
            echo "✓ Troubleshooting guide exists"
          fi

          echo "✓ Module 3 directory structure validated successfully"

  validate-module-3-content:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Module 3 content completeness
        run: |
          MODULE_3_PATH="website/docs/module-3"

          if [ ! -d "$MODULE_3_PATH" ]; then
            echo "ERROR: Module 3 directory not found"
            exit 1
          fi

          echo "Validating Module 3 content..."

          # Validate each week's content
          for week in {1..5}; do
            WEEK_DIR="$MODULE_3_PATH/week-$week"

            if [ -d "$WEEK_DIR" ]; then
              echo "Validating Week $week content..."

              # Check each markdown file in the week
              for md_file in "$WEEK_DIR"/*.md; do
                if [ -f "$md_file" ]; then
                  FILENAME=$(basename "$md_file")

                  # Check if file has content beyond frontmatter
                  CONTENT_LINES=$(wc -l < "$md_file")
                  FRONTMATTER_LINES=$(sed -n '/^---$/,/^---$/p' "$md_file" | wc -l)
                  ACTUAL_CONTENT_LINES=$((CONTENT_LINES - FRONTMATTER_LINES))

                  if [ "$ACTUAL_CONTENT_LINES" -lt 10 ]; then
                    echo "WARNING: $FILENAME in Week $week has minimal content ($ACTUAL_CONTENT_LINES lines)"
                  else
                    echo "✓ $FILENAME has sufficient content"
                  fi

                  # Check for Isaac Sim/ROS keywords based on the module topic
                  if [[ "$FILENAME" == *"isaac-sim"* || "$FILENAME" == *"perception"* || "$FILENAME" == *"navigation"* ]]; then
                    if ! grep -i -q "isaac\|sim\|ros\|lidar\|camera" "$md_file"; then
                      echo "WARNING: $FILENAME may lack relevant Isaac Sim/ROS content"
                    fi
                  fi
                fi
              done
            fi
          done

          echo "✓ Module 3 content validated successfully"

  validate-module-3-spec-compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Module 3 spec compliance
        run: |
          SPEC_FILE="specs/007-author-module-3/spec.md"
          TASKS_FILE="specs/007-author-module-3/tasks.md"

          if [ ! -f "$SPEC_FILE" ]; then
            echo "INFO: Module 3 spec file not found (might be acceptable)"
          else
            echo "Validating Module 3 spec..."

            # Check for required user stories
            USER_STORY_COUNT=$(grep -c "### User Story" "$SPEC_FILE" || echo "0")
            if [ "$USER_STORY_COUNT" -lt 4 ]; then
              echo "WARNING: Expected at least 4 user stories, found $USER_STORY_COUNT"
            else
              echo "✓ Found $USER_STORY_COUNT user stories in spec"
            fi

            # Check for functional requirements
            FR_COUNT=$(grep -c "FR-[0-9]\+:" "$SPEC_FILE" || echo "0")
            if [ "$FR_COUNT" -lt 5 ]; then
              echo "WARNING: Expected at least 5 functional requirements, found $FR_COUNT"
            else
              echo "✓ Found $FR_COUNT functional requirements in spec"
            fi

            # Check for success criteria
            SC_COUNT=$(grep -c "SC-[0-9]\+:" "$SPEC_FILE" || echo "0")
            if [ "$SC_COUNT" -lt 3 ]; then
              echo "WARNING: Expected at least 3 success criteria, found $SC_COUNT"
            else
              echo "✓ Found $SC_COUNT success criteria in spec"
            fi
          fi

          if [ ! -f "$TASKS_FILE" ]; then
            echo "INFO: Module 3 tasks file not found (might be acceptable)"
          else
            echo "Validating Module 3 tasks..."

            # Check for completed tasks
            COMPLETED_TASKS=$(grep -c "\[X\]" "$TASKS_FILE" || echo "0")
            TOTAL_TASKS=$(grep -c "\[.\]" "$TASKS_FILE" || echo "0")

            if [ "$TOTAL_TASKS" -gt 0 ]; then
              COMPLETION_RATE=$(echo "scale=2; $COMPLETED_TASKS * 100 / $TOTAL_TASKS" | bc)
              echo "✓ Found $COMPLETED_TASKS/$TOTAL_TASKS completed tasks ($COMPLETION_RATE% completion)"
            else
              echo "INFO: No tasks found in tasks file"
            fi
          fi

  build-and-test-module-3:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: website

      - name: Build website focusing on Module 3
        run: |
          # Build the entire site to ensure Module 3 integrates properly
          npm run build
        working-directory: website

      - name: Verify Module 3 pages are accessible
        run: |
          BUILD_DIR="website/build"

          if [ ! -d "$BUILD_DIR" ]; then
            echo "ERROR: Build directory not found"
            exit 1
          fi

          # Check that Module 3 pages were built
          MODULE_3_PAGES=$(find "$BUILD_DIR/docs/module-3" -name "*.html" -type f 2>/dev/null | wc -l)

          if [ "$MODULE_3_PAGES" -gt 0 ]; then
            echo "✓ Built $MODULE_3_PAGES Module 3 pages"
          else
            echo "WARNING: No Module 3 pages found in build output"
          fi

          # Verify key Module 3 pages exist
          KEY_PAGES=(
            "docs/module-3/index.html"
            "docs/module-3/week-1/introduction-to-isaac-sim.html"
            "docs/module-3/week-2/perception-pipelines-overview.html"
            "docs/module-3/week-3/navigation-pipeline-basics.html"
            "docs/module-3/week-4/sim-to-real-concepts.html"
            "docs/module-3/week-5/module-3-assessment.html"
          )

          for page in "${KEY_PAGES[@]}"; do
            if [ -f "$BUILD_DIR/$page" ]; then
              echo "✓ $page exists in build"
            else
              echo "WARNING: $page not found in build"
            fi
          done

  validate-cross-links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check cross-module linking
        run: |
          MODULE_3_PATH="website/docs/module-3"

          if [ -d "$MODULE_3_PATH" ]; then
            echo "Checking cross-module links in Module 3..."

            # Look for references to other modules
            for md_file in "$MODULE_3_PATH"/*.md "$MODULE_3_PATH"/week-*/ *.md; do
              if [ -f "$md_file" ]; then
                # Check for links to other modules
                if grep -q "module-\[1-4\]" "$md_file" || grep -q "/docs/module-\[1-4\]/" "$md_file"; then
                  echo "✓ Found cross-module links in $(basename "$md_file")"
                fi

                # Check for links to Isaac Sim/ROS documentation
                if grep -i -q "isaac.*sim\|isaac.*ros\|nvidia" "$md_file"; then
                  echo "✓ Found Isaac Sim/ROS references in $(basename "$md_file")"
                fi
              fi
            done
          fi