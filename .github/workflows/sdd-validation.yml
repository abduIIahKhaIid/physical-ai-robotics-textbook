name: SDD Process Validation

on:
  push:
    branches: [ main, 007-author-module-3 ]
    paths:
      - 'specs/**'
      - '.specify/**'
      - 'history/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'specs/**'
      - '.specify/**'
      - 'history/**'

jobs:
  validate-spec-completeness:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check spec file structure
        run: |
          # Find all spec files
          SPEC_FILES=$(find specs -name "spec.md" 2>/dev/null || true)

          if [ -n "$SPEC_FILES" ]; then
            echo "Validating spec files:"
            for spec in $SPEC_FILES; do
              echo "Checking: $spec"

              # Validate required sections exist
              if ! grep -q "## User Scenarios & Testing" "$spec"; then
                echo "ERROR: Missing 'User Scenarios & Testing' section in $spec"
                exit 1
              fi

              if ! grep -q "## Requirements" "$spec"; then
                echo "ERROR: Missing 'Requirements' section in $spec"
                exit 1
              fi

              if ! grep -q "## Success Criteria" "$spec"; then
                echo "ERROR: Missing 'Success Criteria' section in $spec"
                exit 1
              fi

              # Check for basic spec completeness
              TITLE=$(head -10 "$spec" | grep "# " | head -1 | cut -d'#' -f2- | xargs)
              if [ -z "$TITLE" ] || [ "$TITLE" = "" ]; then
                echo "ERROR: No title found in $spec"
                exit 1
              fi

              echo "✓ $spec validated successfully"
            done
          else
            echo "No spec files found to validate"
          fi

  validate-plan-consistency:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check plan/spec consistency
        run: |
          # Find all plan files
          PLAN_FILES=$(find specs -name "plan.md" 2>/dev/null || true)

          if [ -n "$PLAN_FILES" ]; then
            echo "Validating plan files:"
            for plan in $PLAN_FILES; do
              echo "Checking: $plan"

              # Validate required sections exist
              if ! grep -q "## Summary" "$plan"; then
                echo "ERROR: Missing 'Summary' section in $plan"
                exit 1
              fi

              if ! grep -q "## Technical Context" "$plan"; then
                echo "ERROR: Missing 'Technical Context' section in $plan"
                exit 1
              fi

              # Check if plan references corresponding spec
              SPEC_PATH="${plan%plan.md}spec.md"
              if [ ! -f "$SPEC_PATH" ]; then
                echo "WARNING: Corresponding spec not found for $plan (expected: $SPEC_PATH)"
              else
                echo "✓ Found corresponding spec for $plan"
              fi

              echo "✓ $plan validated successfully"
            done
          else
            echo "No plan files found to validate"
          fi

  validate-tasks-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check tasks completeness
        run: |
          # Find all task files
          TASK_FILES=$(find specs -name "tasks.md" 2>/dev/null || true)

          if [ -n "$TASK_FILES" ]; then
            echo "Validating task files:"
            for task in $TASK_FILES; do
              echo "Checking: $task"

              # Validate required sections exist
              if ! grep -q "# Tasks:" "$task"; then
                echo "ERROR: Missing 'Tasks' header in $task"
                exit 1
              fi

              # Check for at least some tasks
              TASK_COUNT=$(grep -c "\[.+\] T[0-9]\+" "$task" || echo "0")
              if [ "$TASK_COUNT" -lt 1 ]; then
                echo "WARNING: No tasks found in $task"
              else
                COMPLETED_TASKS=$(grep -c "\[X\]" "$task" || echo "0")
                TOTAL_TASKS=$(grep -c "\[.\]" "$task" || echo "0")
                echo "Found $COMPLETED_TASKS/$TOTAL_TASKS completed tasks in $task"
              fi

              echo "✓ $task validated successfully"
            done
          else
            echo "No task files found to validate"
          fi

  validate-history-record:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check PHR (Prompt History Record) structure
        run: |
          # Find all PHR files
          PHR_FILES=$(find history/prompts -name "*.prompt.md" 2>/dev/null || true)

          if [ -n "$PHR_FILES" ]; then
            echo "Validating PHR files:"
            for phr in $PHR_FILES; do
              echo "Checking: $phr"

              # Validate required PHR sections exist
              if ! grep -q "PROMPT_TEXT:" "$phr"; then
                echo "ERROR: Missing PROMPT_TEXT section in $phr"
                exit 1
              fi

              if ! grep -q "RESPONSE_TEXT:" "$phr"; then
                echo "ERROR: Missing RESPONSE_TEXT section in $phr"
                exit 1
              fi

              echo "✓ $phr validated successfully"
            done
          else
            echo "No PHR files found to validate"
          fi

  validate-constitution-compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check constitution compliance
        run: |
          CONSTITUTION_FILE=".specify/memory/constitution.md"

          if [ -f "$CONSTITUTION_FILE" ]; then
            echo "Validating constitution compliance:"

            # Check for core principles
            if ! grep -q "Documentation-First Approach" "$CONSTITUTION_FILE"; then
              echo "ERROR: Missing 'Documentation-First Approach' in constitution"
              exit 1
            fi

            if ! grep -q "Test-First (NON-NEGOTIABLE)" "$CONSTITUTION_FILE"; then
              echo "ERROR: Missing 'Test-First' principle in constitution"
              exit 1
            fi

            if ! grep -q "Secure Architecture" "$CONSTITUTION_FILE"; then
              echo "ERROR: Missing 'Secure Architecture' principle in constitution"
              exit 1
            fi

            echo "✓ Constitution validated successfully"
          else
            echo "Constitution file not found, skipping validation"
          fi